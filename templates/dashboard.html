<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMW CarData Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #0066cc, #004499);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status.connected {
            background-color: #4CAF50;
            color: white;
        }
        
        .status.disconnected {
            background-color: #f44336;
            color: white;
        }
        
        .categories-container {
            margin-top: 20px;
        }
        
        .category-section {
            margin-bottom: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .category-header {
            background: linear-gradient(135deg, #0066cc, #004499);
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .category-header:hover {
            background: linear-gradient(135deg, #0056b3, #003875);
        }
        
        .category-title {
            flex-grow: 1;
        }
        
        .category-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .category-description {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .category-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .category-toggle {
            font-size: 20px;
            transition: transform 0.3s ease;
        }
        
        .category-toggle.collapsed {
            transform: rotate(-90deg);
        }
        
        .category-content {
            padding: 20px;
            transition: max-height 0.3s ease;
            overflow: hidden;
        }
        
        .category-content.collapsed {
            max-height: 0;
            padding: 0 20px;
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .data-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #0066cc;
            transition: all 0.3s ease;
        }
        
        .data-card.flash {
            animation: flashUpdate 0.6s ease;
            border-left-color: #ff6b35;
        }
        
        @keyframes flashUpdate {
            0% { 
                background-color: #fff3cd;
                transform: scale(1.02);
            }
            50% { 
                background-color: #ffeaa7;
                transform: scale(1.05);
            }
            100% { 
                background-color: white;
                transform: scale(1);
            }
        }
        
        .data-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .data-value {
            font-size: 24px;
            color: #0066cc;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .data-timestamp {
            font-size: 12px;
            color: #666;
        }
        
        .data-key {
            font-size: 11px;
            color: #999;
            font-family: monospace;
            margin-top: 5px;
            word-break: break-all;
            overflow-wrap: break-word;
        }
        
        .no-data {
            text-align: center;
            color: #666;
            font-style: italic;
            grid-column: 1 / -1;
            padding: 40px;
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 40px;
        }
        
        .stats {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #0066cc;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>BMW CarData Dashboard</h1>
        <span>Connection Status:</span>
        <span id="status" class="status disconnected">Disconnected</span>
    </div>
    
    <div class="stats">
        <div class="stat-item">
            <div id="data-count" class="stat-value">0</div>
            <div class="stat-label">Data Points</div>
        </div>
        <div class="stat-item">
            <div id="last-update" class="stat-value">--</div>
            <div class="stat-label">Last Update</div>
        </div>
        <div class="stat-item">
            <div id="update-rate" class="stat-value">--</div>
            <div class="stat-label">Updates/min</div>
        </div>
    </div>
    
    <div id="data-container" class="categories-container">
    </div>

    <script>
        const socket = io();
        let updateCount = 0;
        let lastUpdateTime = Date.now();
        let categories = {}; // Track category sections
        
        // Track update rate
        setInterval(() => {
            const now = Date.now();
            const rate = Math.round((updateCount * 60000) / (now - lastUpdateTime));
            document.getElementById('update-rate').textContent = rate;
            updateCount = 0;
            lastUpdateTime = now;
        }, 60000);
        
        function createCategorySection(categoryName, categoryDescription, categoryRank) {
            if (categories[categoryName]) {
                return categories[categoryName];
            }
            
            const container = document.getElementById('data-container');
            const section = document.createElement('div');
            section.className = 'category-section';
            section.id = 'category-' + categoryName.replace(/[^a-zA-Z0-9]/g, '_');
            
            section.innerHTML = `
                <div class="category-header" onclick="toggleCategory('${categoryName}')">
                    <div class="category-title">
                        <div class="category-name">${categoryName}</div>
                        <div class="category-description">${categoryDescription || ''}</div>
                    </div>
                    <span class="category-badge">0 items</span>
                    <span class="category-toggle">▼</span>
                </div>
                <div class="category-content">
                    <div class="data-grid"></div>
                </div>
            `;
            
            // Insert section in rank order
            const existingSections = Array.from(container.children);
            const insertPosition = existingSections.findIndex(existingSection => {
                const existingCategoryName = existingSection.id.replace('category-', '').replace(/_/g, ' ');
                const existingCategory = Object.values(categories).find(cat => cat.name === existingCategoryName);
                return existingCategory && existingCategory.rank > categoryRank;
            });
            
            if (insertPosition === -1) {
                container.appendChild(section);
            } else {
                container.insertBefore(section, existingSections[insertPosition]);
            }
            
            categories[categoryName] = {
                element: section,
                name: categoryName,
                description: categoryDescription,
                rank: categoryRank || 999,
                itemCount: 0
            };
            
            return categories[categoryName];
        }
        
        function toggleCategory(categoryName) {
            const category = categories[categoryName];
            if (!category) return;
            
            const content = category.element.querySelector('.category-content');
            const toggle = category.element.querySelector('.category-toggle');
            
            content.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
        }
        
        function updateCategoryCount(categoryName) {
            const category = categories[categoryName];
            if (!category) return;
            
            const grid = category.element.querySelector('.data-grid');
            const count = grid.children.length;
            const badge = category.element.querySelector('.category-badge');
            badge.textContent = `${count} item${count !== 1 ? 's' : ''}`;
            category.itemCount = count;
        }
        
        function formatValue(value, datatype, unit) {
            // Enhanced value formatting with type casting
            let formattedValue = value;
            
            // Cast to appropriate type
            switch(datatype) {
                case 'float':
                case 'double':
                    if (typeof value === 'string' && !isNaN(value)) {
                        formattedValue = parseFloat(value);
                        // Format with appropriate decimal places
                        if (formattedValue % 1 !== 0) {
                            formattedValue = formattedValue.toFixed(2);
                        }
                    }
                    break;
                case 'int16':
                case 'int32':
                case 'int8':
                case 'uint16':
                case 'uint32':
                case 'uint8':
                    if (typeof value === 'string' && !isNaN(value)) {
                        formattedValue = parseInt(value);
                    }
                    break;
                case 'boolean':
                    if (typeof value === 'string') {
                        formattedValue = value.toLowerCase() === 'true' ? '✓' : '✗';
                    } else {
                        formattedValue = value ? '✓' : '✗';
                    }
                    break;
            }
            
            // Add unit if available
            if (unit && unit.trim() && unit !== '-') {
                return `${formattedValue} ${unit}`;
            }
            
            return formattedValue;
        }
        
        socket.on('connect', function() {
            console.log('Connected to server');
        });
        
        socket.on('connection_status', function(data) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
            statusEl.className = 'status ' + data.status;
        });
        
        socket.on('initial_data', function(data) {
            console.log('Received initial data:', data);
            renderData(data.data);
        });
        
        socket.on('data_update', function(data) {
            console.log('Received data update:', data);
            updateCount++;
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
            
            data.updates.forEach(update => {
                updateDataPoint(update);
            });
        });
        
        function renderData(data) {
            const container = document.getElementById('data-container');
            container.innerHTML = '';
            categories = {}; // Reset categories
            
            if (Object.keys(data).length === 0) {
                return;
            }
            
            document.getElementById('data-count').textContent = Object.keys(data).length;
            
            // Group data by category first
            const categorizedData = {};
            Object.entries(data).forEach(([key, value]) => {
                const category = value.category || 'Unknown';
                if (!categorizedData[category]) {
                    categorizedData[category] = [];
                }
                categorizedData[category].push([key, value]);
            });
            
            // Sort categories by rank, then create sections
            Object.entries(categorizedData)
                .sort(([catA, itemsA], [catB, itemsB]) => {
                    const rankA = itemsA[0] && itemsA[0][1].category_rank || 999;
                    const rankB = itemsB[0] && itemsB[0][1].category_rank || 999;
                    return rankA - rankB;
                })
                .forEach(([categoryName, items]) => {
                    const firstItem = items[0][1];
                    createCategorySection(categoryName, firstItem.category_description, firstItem.category_rank);
                    
                    // Sort items within category alphabetically
                    items.sort(([a], [b]) => a.localeCompare(b))
                         .forEach(([key, value]) => {
                             createDataCard(key, value);
                         });
                });
        }
        
        function createDataCard(key, data) {
            const categoryName = data.category || 'Unknown';
            
            // Ensure category section exists
            if (!categories[categoryName]) {
                createCategorySection(categoryName, data.category_description, data.category_rank);
            }
            
            const categoryGrid = categories[categoryName].element.querySelector('.data-grid');
            const card = document.createElement('div');
            card.className = 'data-card';
            card.id = 'card-' + key.replace(/[^a-zA-Z0-9]/g, '_');
            card.dataset.key = key; // Store original key for sorting
            card.dataset.category = categoryName;
            
            // Get datatype for enhanced formatting
            const datatype = data.datatype;
            const displayValue = formatValue(data.value, datatype, data.unit);
            
            card.innerHTML = `
                <div class="data-name">${data.display_name}</div>
                <div class="data-value">${displayValue}</div>
                <div class="data-timestamp">${new Date(data.timestamp).toLocaleString()}</div>
                <div class="data-key">${key}</div>
            `;
            
            // Find correct position to insert card alphabetically within category
            const existingCards = Array.from(categoryGrid.children);
            const insertPosition = existingCards.findIndex(existingCard => 
                existingCard.dataset.key > key
            );
            
            if (insertPosition === -1) {
                // Insert at end if no card comes after this one alphabetically
                categoryGrid.appendChild(card);
            } else {
                // Insert before the first card that comes after this one alphabetically
                categoryGrid.insertBefore(card, existingCards[insertPosition]);
            }
            
            // Update category count
            updateCategoryCount(categoryName);
        }
        
        function updateDataPoint(update) {
            const cardId = 'card-' + update.key.replace(/[^a-zA-Z0-9]/g, '_');
            let card = document.getElementById(cardId);
            
            if (!card) {
                // Create new card if it doesn't exist
                createDataCard(update.key, {
                    value: update.value,
                    timestamp: update.timestamp,
                    display_name: update.display_name,
                    unit: update.unit,
                    category: update.category,
                    category_description: update.category_description,
                    category_rank: update.category_rank,
                    datatype: update.datatype
                });
                card = document.getElementById(cardId);
            } else {
                // Update existing card content
                const displayValue = formatValue(update.value, update.datatype, update.unit);
                card.querySelector('.data-value').textContent = displayValue;
                card.querySelector('.data-timestamp').textContent = new Date(update.timestamp).toLocaleString();
                
                // Flash effect for changes
                if (update.changed) {
                    card.classList.add('flash');
                    setTimeout(() => {
                        card.classList.remove('flash');
                    }, 600);
                }
            }
            
            // Update data count
            const dataCount = document.querySelectorAll('.data-card').length;
            document.getElementById('data-count').textContent = dataCount;
        }
        
        socket.on('disconnect', function() {
            console.log('Disconnected from server');
            document.getElementById('status').textContent = 'Disconnected';
            document.getElementById('status').className = 'status disconnected';
        });
    </script>
</body>
</html>